# 개발
# 현재 git push 할 때 되는걸로 내가 해놓음

좋아. 구조 파악했고, Cloud Run 배포까지 보면서 딱 필요한 것만 바로 잡아줄게. 결론부터:

* 지금 `cloudbuilt.yaml`(오타)에서 **Dockerfile 경로가 틀림**(`dcmmwebpage/Dockerfile` → 실제는 루트 `./Dockerfile`).
* **Vite 환경변수(Build ARG)**를 Cloud Build에서 **전달 안 함** → 빌드 시 `import.meta.env` 비어있을 가능성 큼.
* 레지스트리는 `gcr.io`로 되어 있는데, 그대로 써도 되지만 요즘은 **Artifact Registry**(권장)로 가는 게 안전.
* SPA 라우팅 Nginx 설정은 OK.
* `cors.json`은 로컬만 허용 → **프로덕션 도메인도 추가** 필요.
* Firestore 규칙 파일 이름은 디렉터리엔 `firestore.rules`로 맞고, 본문에만 “firestroe” 오타. 파일 자체는 문제 없어 보임.

아래 “딱 필요한 수정본”을 그대로 붙여 쓰면 된다. (네가 요구한 대로, 모든 코드 상단에 **파일 경로 주석** 달았고, **주석 충분히** 넣었다.)

---

### 1) Cloud Build 설정(이름도 표준으로 교체)

```yaml
//cloudbuild.yaml
# Cloud Build가 Docker 이미지를 빌드하고 Cloud Run에 배포하는 파이프라인
# - Artifact Registry를 권장하지만, 당장 gcr.io를 그대로 유지하는 버전
# - Vite 환경변수를 Docker Build ARG로 안전하게 전달

options:
  logging: CLOUD_LOGGING_ONLY

# ⚠️ 트리거에서 채우는 치환 변수(underscore 필수)
substitutions:
  _REGION: asia-northeast3                    # 서울
  _SERVICE: dcmmweb                           # Cloud Run 서비스 이름
  _AR_HOSTNAME: gcr.io                        # gcr.io 유지 (권장: Artifact Registry)
  _VITE_FIREBASE_API_KEY: ""                  # 트리거에서 채움
  _VITE_FIREBASE_AUTH_DOMAIN: ""
  _VITE_FIREBASE_PROJECT_ID: ""
  _VITE_FIREBASE_STORAGE_BUCKET: ""
  _VITE_FIREBASE_MESSAGING_SENDER_ID: ""
  _VITE_FIREBASE_APP_ID: ""

images:
  - ${_AR_HOSTNAME}/${PROJECT_ID}/github.com/${REPO_NAME}:${SHORT_SHA}

steps:
  # 1) Docker Build (루트 Dockerfile 사용) + Vite 빌드 인자 전달
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - ${_AR_HOSTNAME}/${PROJECT_ID}/github.com/${REPO_NAME}:${SHORT_SHA}
      - -f
      - Dockerfile                # ← 루트 Dockerfile 사용 (기존 경로 오류 수정)
      - .
      # ----- Vite Build ARG -----
      - --build-arg
      - VITE_FIREBASE_API_KEY=${_VITE_FIREBASE_API_KEY}
      - --build-arg
      - VITE_FIREBASE_AUTH_DOMAIN=${_VITE_FIREBASE_AUTH_DOMAIN}
      - --build-arg
      - VITE_FIREBASE_PROJECT_ID=${_VITE_FIREBASE_PROJECT_ID}
      - --build-arg
      - VITE_FIREBASE_STORAGE_BUCKET=${_VITE_FIREBASE_STORAGE_BUCKET}
      - --build-arg
      - VITE_FIREBASE_MESSAGING_SENDER_ID=${_VITE_FIREBASE_MESSAGING_SENDER_ID}
      - --build-arg
      - VITE_FIREBASE_APP_ID=${_VITE_FIREBASE_APP_ID}

  # 2) 이미지 푸시
  - name: gcr.io/cloud-builders/docker
    args: ["push", "${_AR_HOSTNAME}/${PROJECT_ID}/github.com/${REPO_NAME}:${SHORT_SHA}"]

  # 3) Cloud Run 배포
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_SERVICE}
      - --image=${_AR_HOSTNAME}/${PROJECT_ID}/github.com/${REPO_NAME}:${SHORT_SHA}
      - --region=${_REGION}
      - --platform=managed
      - --allow-unauthenticated
      - --port=8080               # Nginx가 8080 리스닝 → Cloud Run 포트 명시
```

> **트리거 팁**
> Cloud Build 트리거에서 위 `_VITE_…` 값들만 채워주면 된다.
> (예: `_VITE_FIREBASE_PROJECT_ID=sulwha` 등)

---

### 2) Dockerfile (지금 그대로 OK, 주석만 조금 보강)

```dockerfile
//Dockerfile
# --- Build stage ---
FROM node:20-alpine AS build
WORKDIR /app

# 1) Vite 빌드 타임 환경변수(Cloud Build에서 --build-arg로 주입)
ARG VITE_FIREBASE_API_KEY
ARG VITE_FIREBASE_AUTH_DOMAIN
ARG VITE_FIREBASE_PROJECT_ID
ARG VITE_FIREBASE_STORAGE_BUCKET
ARG VITE_FIREBASE_MESSAGING_SENDER_ID
ARG VITE_FIREBASE_APP_ID

# 2) Vite에서 import.meta.env로 사용할 수 있게 ENV로 승격
ENV VITE_FIREBASE_API_KEY=$VITE_FIREBASE_API_KEY
ENV VITE_FIREBASE_AUTH_DOMAIN=$VITE_FIREBASE_AUTH_DOMAIN
ENV VITE_FIREBASE_PROJECT_ID=$VITE_FIREBASE_PROJECT_ID
ENV VITE_FIREBASE_STORAGE_BUCKET=$VITE_FIREBASE_STORAGE_BUCKET
ENV VITE_FIREBASE_MESSAGING_SENDER_ID=$VITE_FIREBASE_MESSAGING_SENDER_ID
ENV VITE_FIREBASE_APP_ID=$VITE_FIREBASE_APP_ID

# 3) 의존성 설치 + 빌드
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build   # ← 여기서 ENV 값을 사용해 정적 번들 생성

# --- Serve stage ---
FROM nginx:stable-alpine

# 4) SPA 라우팅 + 정적 캐시 헤더 (immutable 캐시)
RUN printf 'server {\n  listen 8080;\n  server_name _;\n  root /usr/share/nginx/html;\n  index index.html;\n  location / { try_files $uri /index.html; }\n  location ~* \\.(js|css|png|jpg|jpeg|gif|svg|ico|webp|woff2?)$ { expires 1y; add_header Cache-Control "public, immutable"; }\n}\n' > /etc/nginx/conf.d/default.conf

# 5) 정적 파일 복사
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 8080
CMD ["nginx","-g","daemon off;"]
```

---

### 3) CORS(Cloud Storage) — 프로덕션 도메인 추가

```json
//cors.json
[
  {
    "origin": [
      "http://localhost:5500",
      "https://dcmmweb-프로덕션도메인"   // ← 실제 서비스 도메인 추가
    ],
    "method": ["GET", "POST", "PUT", "DELETE"],
    "maxAgeSeconds": 3600,
    "responseHeader": ["Content-Type", "Authorization", "x-goog-meta-*"]
  }
]
```

적용 명령:

```bash
# 버킷명 바꿔서 실행 (예: gs://sulwha.appspot.com)
gsutil cors set cors.json gs://<YOUR_STORAGE_BUCKET>
gsutil cors get gs://<YOUR_STORAGE_BUCKET>
```

---

### 4) Firestore 보안 규칙(현재 최소 구성 OK, 주석만 보강)

```
//firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // users/{uid} 문서는 로그인한 본인만 읽기/쓰기
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // TODO: assignments, submit 등 컬렉션 추가 시 여기서 컬렉션별 규칙 확장
  }
}
```

> 네가 이미 정의한 `assignedQuestions`, `assignments`, `submit` 경로를 쓸 거면
> 그에 맞춰 아래처럼 컬렉션을 추가로 열어두면 된다(예시).

```
//firestore.rules (확장 예시)
match /assignments/{uid}/{paperId}/{doc=**} {
  allow read, write: if request.auth != null && request.auth.uid == uid;
}
match /submit/{uid}/{doc=**} {
  allow read, write: if request.auth != null && request.auth.uid == uid;
}
```

---

### 5) (선택) Artifact Registry로 전환하고 싶다면

* 레지스트리 생성:

  ```bash
  gcloud artifacts repositories create web --repository-format=docker --location=asia-northeast3
  ```
* `cloudbuild.yaml`의 `_AR_HOSTNAME`을:

  ```
  asia-northeast3-docker.pkg.dev
  ```

  로 바꾸고 `images:`/`--image=` 경로도:

  ```
  asia-northeast3-docker.pkg.dev/${PROJECT_ID}/web/${REPO_NAME}:${SHORT_SHA}
  ```

  형태로 맞추면 끝.

---

### 6) 수동 테스트(로컬 빌드·런)

```bash
# 로컬 Docker 빌드 (실제 값으로 대입)
docker build \
  -t dcmmweb:local \
  --build-arg VITE_FIREBASE_API_KEY=... \
  --build-arg VITE_FIREBASE_AUTH_DOMAIN=... \
  --build-arg VITE_FIREBASE_PROJECT_ID=... \
  --build-arg VITE_FIREBASE_STORAGE_BUCKET=... \
  --build-arg VITE_FIREBASE_MESSAGING_SENDER_ID=... \
  --build-arg VITE_FIREBASE_APP_ID=... \
  .

# 실행
docker run --rm -p 8080:8080 dcmmweb:local
# → http://localhost:8080 접속 확인
```

---

### 7) 한 줄 체크리스트

* [x] `cloudbuild.yaml`로 파일명 통일(오타 제거) + **Dockerfile 경로 수정**
* [x] **Vite Build ARG 전달**을 Cloud Build에 추가
* [x] Cloud Run 포트 `8080` 명시
* [x] 프로덕션 **CORS 도메인 추가** (`cors.json` 적용)
* [x] Firestore 규칙은 현재 최소 구성 OK, 컬렉션 늘리면 규칙도 확장
* [ ] (선택) 레지스트리 `Artifact Registry`로 이전

필요하면 내가 `assignments/submit` 규칙도 네 현재 컬렉션 구조 그대로 반영해서 완성본 적어줄게.


